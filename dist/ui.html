<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      --color-bg: var(--figma-color-bg);
      --color-bg-secondary: var(--figma-color-bg-secondary);
      --color-bg-hover: var(--figma-color-bg-hover);
      --color-bg-active: var(--figma-color-bg-pressed);
      --color-bg-disabled: var(--figma-color-bg-disabled);
      --color-border: var(--figma-color-border);
      --color-border-focus: var(--figma-color-border-selected);
      --color-text: var(--figma-color-text);
      --color-text-tertiary: var(--figma-color-text-tertiary);
      --color-text-disabled: var(--figma-color-text-disabled);
      --color-bg-brand: var(--figma-color-bg-brand);
      --color-bg-brand-hover: var(--figma-color-bg-brand-hover);
      --color-bg-brand-active: var(--figma-color-bg-brand-pressed);
      --color-text-onbrand: var(--figma-color-text-onbrand);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 16px;
    }

    textarea {
      width: 100%;
      height: 200px;
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px;
    }

    select, input[type="text"] {
      width: 100%;
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px;
      margin-top: 4px;
    }

    textarea:focus-visible {
      outline: none;
      border-color: var(--color-border-focus);
    }

    textarea::placeholder {
      color: var(--color-text-tertiary);
    }

    button {
      margin-top: 8px;
      background: var(--color-bg-brand);
      color: var(--color-text-onbrand);
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    button:disabled {
      background: var(--color-bg-disabled);
      color: var(--color-text-disabled);
      cursor: default;
    }

    button:hover {
      background: var(--color-bg-brand-hover);
    }

    button:active {
      background: var(--color-bg-brand-active);
    }

    button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--color-border-focus);
    }

    #preview {
      margin-top: 12px;
      max-height: 120px;
      overflow-y: auto;
      border-top: 1px solid var(--color-border);
      padding-top: 8px;
    }

    .preview-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .preview-group {
      font-weight: bold;
      margin-top: 4px;
    }

    .preview-item-inner {
      display: flex;
      align-items: center;
      margin-left: 8px;
    }

    .scope-select {
      margin-left: 4px;
      font-size: 11px;
    }

    .preview-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid var(--color-border);
      margin-right: 6px;
    }

    .preview-name {
      flex: 1;
    }

    .preview-scopes {
      color: var(--color-text-tertiary);
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h2>Paste CSS Variables</h2>
  <textarea id="cssInput" placeholder="--primary: #ff0000;\n--spacing: 8px;"></textarea>
  <br />
  <label for="collectionSelect">Collection:</label>
  <select id="collectionSelect"></select>
  <input id="newCollection" type="text" placeholder="New collection name" style="display:none; width: 100%; margin-top: 4px;" />
  <br />
  <button id="import">Import</button>
  <div id="preview"></div>
  <script>
    const textarea = document.getElementById('cssInput');
    const importBtn = document.getElementById('import');
    const select = document.getElementById('collectionSelect');
    const newInput = document.getElementById('newCollection');
    const previewDiv = document.getElementById('preview');
    let scopes = [];
    const scopeLabels = {
      TEXT_CONTENT: 'Text content',
      CORNER_RADIUS: 'Corner radius',
      WIDTH_HEIGHT: 'Width & height',
      GAP: 'Gap',
      ALL_FILLS: 'All fills',
      FRAME_FILL: 'Frame fill',
      SHAPE_FILL: 'Shape fill',
      TEXT_FILL: 'Text fill',
      STROKE_COLOR: 'Stroke color',
      STROKE_FLOAT: 'Stroke width',
      EFFECT_FLOAT: 'Effect size',
      EFFECT_COLOR: 'Effect color',
      OPACITY: 'Opacity',
      FONT_FAMILY: 'Font family',
      FONT_STYLE: 'Font style',
      FONT_WEIGHT: 'Font weight',
      FONT_SIZE: 'Font size',
      LINE_HEIGHT: 'Line height',
      LETTER_SPACING: 'Letter spacing',
      PARAGRAPH_SPACING: 'Paragraph spacing',
      PARAGRAPH_INDENT: 'Paragraph indent'
    };
    const colorScopes = [
      'ALL_FILLS',
      'FRAME_FILL',
      'SHAPE_FILL',
      'TEXT_FILL',
      'STROKE_COLOR',
      'EFFECT_COLOR'
    ];
    const numberScopes = [
      'CORNER_RADIUS',
      'WIDTH_HEIGHT',
      'GAP',
      'STROKE_FLOAT',
      'EFFECT_FLOAT',
      'OPACITY',
      'FONT_WEIGHT',
      'FONT_SIZE',
      'LINE_HEIGHT',
      'LETTER_SPACING',
      'PARAGRAPH_SPACING',
      'PARAGRAPH_INDENT'
    ];
    const itemScopeOverrides = {};
    const groupScopeOverrides = {};

    function toFigmaName(name) {
      const parts = name.split('-');
      if (parts.length > 1) {
        const last = parts.pop();
        return parts.join('/') + '/' + last;
      }
      return name;
    }

    function getGroup(name) {
      const figmaName = toFigmaName(name);
      const idx = figmaName.lastIndexOf('/');
      return idx === -1 ? '' : figmaName.slice(0, idx);
    }

    function sendPreview() {
      parent.postMessage({ pluginMessage: { type: 'preview-css', css: textarea.value } }, '*');
    }

    function updateButtonState() {
      let disabled = textarea.value.trim().length === 0;
      if (!disabled && select.value === '__new__') {
        disabled = newInput.value.trim().length === 0;
      }
      importBtn.disabled = disabled;
      sendPreview();
    }

    textarea.addEventListener('input', updateButtonState);
    newInput.addEventListener('input', updateButtonState);
    select.addEventListener('change', () => {
      newInput.style.display = select.value === '__new__' ? 'block' : 'none';
      updateButtonState();
    });

    function renderScopeSelect(current, allowed) {
      const sel = document.createElement('select');
      sel.className = 'scope-select';
      sel.multiple = true;
      sel.size = Math.min(4, allowed.length + 1);
      const none = document.createElement('option');
      none.value = '';
      none.textContent = 'Auto';
      sel.appendChild(none);
      for (const s of allowed) {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = scopeLabels[s] || s;
        if (current && current.includes(s)) opt.selected = true;
        sel.appendChild(opt);
      }
      if (!current || current.length === 0) none.selected = true;
      return sel;
    }

    function renderPreview(items) {
      previewDiv.innerHTML = '';
      const groups = {};
      for (const item of items) {
        const g = getGroup(item.name);
        if (!groups[g]) groups[g] = [];
        groups[g].push(item);
      }
      for (const [groupName, arr] of Object.entries(groups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'preview-group';
        groupDiv.textContent = groupName || '(root)';
        const allowedScopes = [];
        if (arr.some(i => i.type === 'COLOR')) allowedScopes.push(...colorScopes);
        if (arr.some(i => i.type !== 'COLOR')) allowedScopes.push(...numberScopes);
        const groupSel = renderScopeSelect(groupScopeOverrides[groupName], allowedScopes);
        groupSel.onchange = () => {
          const vals = Array.from(groupSel.selectedOptions).map(o => o.value).filter(v => v);
          if (vals.length) groupScopeOverrides[groupName] = vals; else delete groupScopeOverrides[groupName];
        };
        groupDiv.appendChild(groupSel);
        previewDiv.appendChild(groupDiv);
        for (const item of arr) {
          const div = document.createElement('div');
          div.className = 'preview-item-inner';
          const color = document.createElement('div');
          color.className = 'preview-color';
          if (item.type === 'COLOR') {
            const { r, g, b, a } = item.value;
            color.style.background = `rgba(${Math.round(r*255)}, ${Math.round(g*255)}, ${Math.round(b*255)}, ${a})`;
          } else {
            color.style.background = 'transparent';
          }
          div.appendChild(color);
          const name = document.createElement('div');
          name.className = 'preview-name';
          name.textContent = item.name;
          div.appendChild(name);
          const scopesDiv = document.createElement('div');
          scopesDiv.className = 'preview-scopes';
          scopesDiv.textContent = item.scopes.map(s => scopeLabels[s] || s).join(', ');
          div.appendChild(scopesDiv);
          const scopeSel = renderScopeSelect(itemScopeOverrides[item.name], item.type === 'COLOR' ? colorScopes : numberScopes);
          scopeSel.onchange = () => {
            const vals = Array.from(scopeSel.selectedOptions).map(o => o.value).filter(v => v);
            if (vals.length) itemScopeOverrides[item.name] = vals; else delete itemScopeOverrides[item.name];
          };
          div.appendChild(scopeSel);
          previewDiv.appendChild(div);
        }
      }
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'init') {
        select.innerHTML = '';
        for (const name of msg.collections) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        }
        const newOpt = document.createElement('option');
        newOpt.value = '__new__';
        newOpt.textContent = 'New collection...';
        select.appendChild(newOpt);
        scopes = msg.scopes;
        updateButtonState();
      }
      if (msg.type === 'preview-data') {
        renderPreview(msg.preview);
      }
    };

    updateButtonState();

    importBtn.onclick = () => {
      const css = textarea.value;
      let collectionName = select.value;
      let create = false;
      if (collectionName === '__new__') {
        collectionName = newInput.value.trim();
        create = true;
      }
      parent.postMessage({ pluginMessage: { type: 'import-css', css, collectionName, create, itemScopes: itemScopeOverrides, groupScopes: groupScopeOverrides } }, '*');
    };
  </script>
</body>
</html>
