<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      --color-bg: var(--figma-color-bg);
      --color-bg-secondary: var(--figma-color-bg-secondary);
      --color-bg-hover: var(--figma-color-bg-hover);
      --color-bg-active: var(--figma-color-bg-pressed);
      --color-bg-disabled: var(--figma-color-bg-disabled);
      --color-border: var(--figma-color-border);
      --color-border-focus: var(--figma-color-border-selected);
      --color-text: var(--figma-color-text);
      --color-text-tertiary: var(--figma-color-text-tertiary);
      --color-text-disabled: var(--figma-color-text-disabled);
      --color-bg-brand: var(--figma-color-bg-brand);
      --color-bg-brand-hover: var(--figma-color-bg-brand-hover);
      --color-bg-brand-active: var(--figma-color-bg-brand-pressed);
      --color-text-onbrand: var(--figma-color-text-onbrand);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 16px;
    }

    textarea {
      width: 100%;
      height: 200px;
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px;
    }

    select, input[type="text"] {
      width: 100%;
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px;
      margin-top: 4px;
    }

    textarea:focus-visible {
      outline: none;
      border-color: var(--color-border-focus);
    }

    textarea::placeholder {
      color: var(--color-text-tertiary);
    }

    button {
      margin-top: 8px;
      background: var(--color-bg-brand);
      color: var(--color-text-onbrand);
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    button:disabled {
      background: var(--color-bg-disabled);
      color: var(--color-text-disabled);
      cursor: default;
    }

    button:hover {
      background: var(--color-bg-brand-hover);
    }

    button:active {
      background: var(--color-bg-brand-active);
    }

    button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--color-border-focus);
    }

    #preview {
      margin-top: 12px;
      max-height: 120px;
      overflow-y: auto;
      border-top: 1px solid var(--color-border);
      padding-top: 8px;
    }

    .preview-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .preview-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid var(--color-border);
      margin-right: 6px;
    }

    .preview-name {
      flex: 1;
    }

    .preview-scopes {
      color: var(--color-text-tertiary);
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h2>Paste CSS Variables</h2>
  <textarea id="cssInput" placeholder="--primary: #ff0000;\n--spacing: 8px;"></textarea>
  <br />
  <label for="collectionSelect">Collection:</label>
  <select id="collectionSelect"></select>
  <input id="newCollection" type="text" placeholder="New collection name" style="display:none; width: 100%; margin-top: 4px;" />
  <br />
  <button id="import">Import</button>
  <div id="preview"></div>
  <script>
    const textarea = document.getElementById('cssInput');
    const importBtn = document.getElementById('import');
    const select = document.getElementById('collectionSelect');
    const newInput = document.getElementById('newCollection');
    const previewDiv = document.getElementById('preview');

    function sendPreview() {
      parent.postMessage({ pluginMessage: { type: 'preview-css', css: textarea.value } }, '*');
    }

    function updateButtonState() {
      let disabled = textarea.value.trim().length === 0;
      if (!disabled && select.value === '__new__') {
        disabled = newInput.value.trim().length === 0;
      }
      importBtn.disabled = disabled;
      sendPreview();
    }

    textarea.addEventListener('input', updateButtonState);
    newInput.addEventListener('input', updateButtonState);
    select.addEventListener('change', () => {
      newInput.style.display = select.value === '__new__' ? 'block' : 'none';
      updateButtonState();
    });

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'collections') {
        select.innerHTML = '';
        for (const name of msg.collections) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        }
        const newOpt = document.createElement('option');
        newOpt.value = '__new__';
        newOpt.textContent = 'New collection...';
        select.appendChild(newOpt);
        updateButtonState();
      }
      if (msg.type === 'preview-data') {
        previewDiv.innerHTML = '';
        for (const item of msg.preview) {
          const div = document.createElement('div');
          div.className = 'preview-item';
          const color = document.createElement('div');
          color.className = 'preview-color';
          if (item.type === 'COLOR') {
            const { r, g, b, a } = item.value;
            color.style.background = `rgba(${Math.round(r*255)}, ${Math.round(g*255)}, ${Math.round(b*255)}, ${a})`;
          } else {
            color.style.background = 'transparent';
          }
          div.appendChild(color);
          const name = document.createElement('div');
          name.className = 'preview-name';
          name.textContent = item.name;
          div.appendChild(name);
          const scopes = document.createElement('div');
          scopes.className = 'preview-scopes';
          scopes.textContent = item.scopes.join(', ');
          div.appendChild(scopes);
          previewDiv.appendChild(div);
        }
      }
    };

    updateButtonState();

    importBtn.onclick = () => {
      const css = textarea.value;
      let collectionName = select.value;
      let create = false;
      if (collectionName === '__new__') {
        collectionName = newInput.value.trim();
        create = true;
      }
      parent.postMessage({ pluginMessage: { type: 'import-css', css, collectionName, create } }, '*');
    };
  </script>
</body>
</html>
